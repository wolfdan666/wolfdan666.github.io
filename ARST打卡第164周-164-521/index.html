<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.wolfdan.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="lc710_黑名单中的随机数 A theory of modern Go Go语言类型分支（switch判断空接口中变量的类型） 推荐看书_黑客与画家">
<meta property="og:type" content="article">
<meta property="og:title" content="ARST打卡第164周[164&#x2F;521]">
<meta property="og:url" content="https://www.wolfdan.cn/ARST%E6%89%93%E5%8D%A1%E7%AC%AC164%E5%91%A8-164-521/">
<meta property="og:site_name" content="单林敏的博客">
<meta property="og:description" content="lc710_黑名单中的随机数 A theory of modern Go Go语言类型分支（switch判断空接口中变量的类型） 推荐看书_黑客与画家">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-06-26T13:55:55.000Z">
<meta property="article:modified_time" content="2022-06-26T15:38:35.161Z">
<meta property="article:author" content="单林敏">
<meta property="article:tag" content="ARST">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.wolfdan.cn/ARST%E6%89%93%E5%8D%A1%E7%AC%AC164%E5%91%A8-164-521/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.wolfdan.cn/ARST%E6%89%93%E5%8D%A1%E7%AC%AC164%E5%91%A8-164-521/","path":"ARST打卡第164周-164-521/","title":"ARST打卡第164周[164/521]"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ARST打卡第164周[164/521] | 单林敏的博客</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?953c0cc2db0f1124313d72b95b9d07e1"></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">单林敏的博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">wolfdan's blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-捐赠"><a href="/%E6%8D%90%E8%B5%A0/" rel="section"><i class="fa fa-coins fa-fw"></i>捐赠</a></li>
        <li class="menu-item menu-item-冲冲"><a href="/%E5%86%B2%E5%86%B2%E5%86%B2/" rel="section"><i class="fa fa-rocket fa-fw"></i>冲冲</a></li>
        <li class="menu-item menu-item-友链"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Algorithm"><span class="nav-number">1.</span> <span class="nav-text">Algorithm</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Review"><span class="nav-number">2.</span> <span class="nav-text">Review</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%84%9F%E6%83%B3"><span class="nav-number">2.1.</span> <span class="nav-text">感想</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">2.2.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%9D%E8%AF%95%E4%BB%A5%E5%8F%8A%E6%96%B0%E9%97%AE%E9%A2%98"><span class="nav-number">2.3.</span> <span class="nav-text">尝试以及新问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stackoverflow%E6%9C%80%E7%BB%88%E7%BB%93%E6%9E%9C"><span class="nav-number">2.4.</span> <span class="nav-text">stackoverflow最终结果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tips"><span class="nav-number">3.</span> <span class="nav-text">Tips</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Share"><span class="nav-number">4.</span> <span class="nav-text">Share</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="单林敏"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">单林敏</p>
  <div class="site-description" itemprop="description">心外无物,知行合一</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">292</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">93</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wolfdan666" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wolfdan666" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wolfdan666666@gmail.com" title="E-Mail → mailto:wolfdan666666@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/shanlinmin/activities" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;shanlinmin&#x2F;activities" rel="noopener" target="_blank"><i class="free-code-camp fa-fw"></i>知乎</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/53acec957bf9" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;53acec957bf9" rel="noopener" target="_blank"><i class="book fa-fw"></i>简书</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://me.csdn.net/neve_give_up_dan" title="CSDN → https:&#x2F;&#x2F;me.csdn.net&#x2F;neve_give_up_dan" rel="noopener" target="_blank"><i class="rotate-right fa-fw"></i>CSDN</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.wolfdan.cn/ARST%E6%89%93%E5%8D%A1%E7%AC%AC164%E5%91%A8-164-521/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="单林敏">
      <meta itemprop="description" content="心外无物,知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="单林敏的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ARST打卡第164周[164/521]
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-26 21:55:55 / 修改时间：23:38:35" itemprop="dateCreated datePublished" datetime="2022-06-26T21:55:55+08:00">2022-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ARST/" itemprop="url" rel="index"><span itemprop="name">ARST</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">lc710_黑名单中的随机数 A theory of modern Go Go语言类型分支（switch判断空接口中变量的类型） 推荐看书_黑客与画家</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h1><p>lc710_黑名单中的随机数</p>
<p>思路: 感觉可以直接 index = rand(n - len(blacklist)), 然后构造一个没有blacklist的数组real</p>
<p>返回<code>real[index]</code></p>
<p>这个方法虽然简单易懂，但是被官方的案例<code>[[1000000000,[640145908]]</code>hack了</p>
<p>被案例hack掉的代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Solution <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="built_in">real</span>     []<span class="keyword">int</span></span><br><span class="line">	realSize <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Constructor</span><span class="params">(n <span class="keyword">int</span>, blacklist []<span class="keyword">int</span>)</span> <span class="title">Solution</span></span> &#123;</span><br><span class="line">	blacklistSize := <span class="built_in">len</span>(blacklist)</span><br><span class="line">	realSize := n - blacklistSize</span><br><span class="line">	<span class="keyword">if</span> realSize &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;realSize is valid. lower than zero.&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 好像说这里panic了..[[1000000000,[640145908]]</span></span><br><span class="line">	<span class="comment">// 被官方案例hack了</span></span><br><span class="line">	tmpSlice := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, realSize)</span><br><span class="line">	<span class="comment">// tmpSlice := make([]int, realSize)</span></span><br><span class="line">	<span class="comment">// blacklist = sort.IntSlice(blacklist)</span></span><br><span class="line">	<span class="comment">// IntSlice 只是帮 Slice处理好sort需要的方法，实际的sort还需要调用！</span></span><br><span class="line">	sortT := sort.IntSlice(blacklist)</span><br><span class="line">	sort.Sort(sortT)</span><br><span class="line">	fmt.Println(sortT)</span><br><span class="line">	j := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> j &lt; blacklistSize &amp;&amp; i == sortT[j] &#123;</span><br><span class="line">			j++</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		tmpSlice = <span class="built_in">append</span>(tmpSlice, i)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> Solution&#123;<span class="built_in">real</span>: tmpSlice, realSize: realSize&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *Solution)</span> <span class="title">Pick</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	i := rand.Intn(this.realSize)</span><br><span class="line">	<span class="keyword">return</span> this.<span class="built_in">real</span>[i]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>答案: 局部映射，就能解决问题</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Solution <span class="keyword">struct</span> &#123;</span><br><span class="line">	b2w   <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span></span><br><span class="line">	bound <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Constructor</span><span class="params">(n <span class="keyword">int</span>, blacklist []<span class="keyword">int</span>)</span> <span class="title">Solution</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">len</span>(blacklist)</span><br><span class="line">	bound := n - m</span><br><span class="line">	black := <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">bool</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, b := <span class="keyword">range</span> blacklist &#123;</span><br><span class="line">		<span class="comment">// 只映射黑名单里面值小于 bound 的值</span></span><br><span class="line">		<span class="keyword">if</span> b &gt;= bound &#123;</span><br><span class="line">			black[b] = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	b2w := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, m-<span class="built_in">len</span>(black))</span><br><span class="line">	w := bound</span><br><span class="line">	<span class="keyword">for</span> _, b := <span class="keyword">range</span> blacklist &#123;</span><br><span class="line">		<span class="keyword">if</span> b &lt; bound &#123;</span><br><span class="line">			<span class="keyword">for</span> black[w] &#123;</span><br><span class="line">				w++</span><br><span class="line">			&#125;</span><br><span class="line">			b2w[b] = w</span><br><span class="line">			w++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Solution&#123;b2w, bound&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Solution)</span> <span class="title">Pick</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	x := rand.Intn(s.bound)</span><br><span class="line">	<span class="keyword">if</span> s.b2w[x] &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> s.b2w[x]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p><a target="_blank" rel="noopener" href="https://peter.bourgon.org/blog/2017/06/09/theory-of-modern-go.html">A theory of modern Go</a><br>2017 06 09<br>tl;dr: magic is bad; global state is magic → no package level vars; no func init</p>
<p>The single best property of Go is that it is basically non-magical. With very few exceptions, a straight-line reading of Go code leaves no ambiguity about definitions, dependency relationships, or runtime behavior. This makes Go relatively easy to read, which in turn makes it relatively easy to maintain, which is the single highest virtue of industrial programming.</p>
<p>But there are a few ways that magic can creep in. One unfortunately very common way is through the use of global state. Package-global objects can encode state and/or behavior that is hidden from external callers. Code that calls on those globals can have surprising side effects, which subverts the reader’s ability to understand and mentally model the program.</p>
<p>Functions (including methods) are basically the only mechanism that Go has to build abstraction. Consider the following function definition.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewObject</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(*Object, error)</span></span></span><br></pre></td></tr></table></figure>
<p>By convention, we expect that functions of the form NewXxx are type constructors. That expectation is validated when we see that the function returns a pointer to an Object, and an error. From this we can deduce that the constructor function may or may not succeed, and if it fails, that we will receive an error telling us why. We observe that the function takes a single int parameter, which we assume controls some aspect or capability of the returned Object. Presumably, there is some constraint on n, which, if not met, will result in an error. But because the function takes no other parameter, we expect it should have no other effect, beyond (hopefully) allocating some memory.</p>
<p>By reading the function signature alone, we are able to make all of these deductions, and build a mental model of this function. This process, applied repeatedly and recursively from the first line of func main, is how we read and understand programs.</p>
<p>Now, consider if this were the body of the function.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewObject</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(*Object, error)</span></span> &#123;</span><br><span class="line">	row := dbconn.QueryRow(<span class="string">&quot;SELECT ... FROM ... WHERE ...&quot;</span>)</span><br><span class="line">	<span class="keyword">var</span> id <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> err := row.Scan(&amp;id); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logger.Log(<span class="string">&quot;during row scan: %v&quot;</span>, err)</span><br><span class="line">		id = <span class="string">&quot;default&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	resource, err := pool.Request(n)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;Object&#123;</span><br><span class="line">		id:  id,</span><br><span class="line">		res: resource,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The function invokes a package global database/sql.Conn, to make a query against some unspecified database; a package global logger, to output a string of arbitrary format to some unknown location; and a package global pool object of some kind, to request a resource of some kind. All of these operations have side effects that are completely invisible from an inspection of the function signature. There is no way for a caller to predict any of these things will happen, except by reading the function and diving to the definition of all of the globals.</p>
<p>Consider this alternative signature.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewObject</span><span class="params">(db *sql.DB, pool *resource.Pool, n <span class="keyword">int</span>, logger log.Logger)</span> <span class="params">(*Object, error)</span></span></span><br></pre></td></tr></table></figure>
<p>By lifting each of the dependencies into the signature as parameters, we allow readers to accurately model the scope and potential behaviors of the function. The caller knows exactly what the function needs to do its work, and can provide them accordingly.</p>
<p>If we’re designing the public API for this package, we can even take it one helpful step further.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RowQueryer models part of a database/sql.DB.</span></span><br><span class="line"><span class="keyword">type</span> RowQueryer <span class="keyword">interface</span> &#123;</span><br><span class="line">	QueryRow(<span class="keyword">string</span>, ...<span class="keyword">interface</span>&#123;&#125;) *sql.Row</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Requestor models the requesting side of a resource.Pool.</span></span><br><span class="line"><span class="keyword">type</span> Requestor <span class="keyword">interface</span> &#123;</span><br><span class="line">	Request(n <span class="keyword">int</span>) (*resource.Value, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewObject</span><span class="params">(q RowQueryer, r Requestor, n <span class="keyword">int</span>, logger log.Logger)</span> <span class="params">(*Object, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>By modeling each concrete object as an interface, capturing only the methods we use, we allow callers to swap in alternative implementations. This reduces source-level coupling(耦合) between packages, and enables us to mock out the concrete dependencies in tests. Testing the original version of the code, with concrete package-level globals, involves tedious and error-prone swapping-out of components.</p>
<p>If all of our constructors and functions take their dependencies explicitly, then we no longer have any use for globals. Instead, we can construct all of our database connections, our loggers, our resource pools, in our func main, so that future readers can very clearly map out a component graph. And we can very explicitly pass those dependencies to the components that use them, so that we eliminate the comprehension-subverting magic of globals. Also, observe that if we have no global variables, we have no more use for func init, whose only purpose is to instantiate or mutate package-global state. We can then look at all uses of func init with appropriate suspicion: what is this code doing? Why is it not in func main, where it belongs?</p>
<p>It’s not only possible, but quite easy, and actually extremely refreshing, to write Go programs that are practically free of global state. In my experience, programming in this way is not noticeably slower or more tedious than using global variables to shrink function definitions. On the contrary: when a function signature reliably and completely describes the behavior-scope of the function body, we can reason about, refactor, and maintain code in the large much more efficiently. Go kit has been written in this style since the very beginning, to its great benefit.</p>
<p>— – -</p>
<p>From this, we can develop a theory of modern Go. Based on the words of Dave “Humbug” Cheney, I propose the following guidelines:</p>
<ul>
<li>No package level variables</li>
<li>No func init</li>
</ul>
<p>There are exceptions, of course. But from these rules, the other practices follow naturally.</p>
<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><p>确实，全局变量虽然可以减少定义时的代码量，但坏处是对库调用者隐藏了太多的东西，而且不利于库调用者理解都是干了啥，并且会在报错的时候，让调用者完全没有办法</p>
<p>而通过接口式的方式暴露出需要的参数，方便调用者可以更加方便的进行参数修改，减少代码耦合性</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>还是不能使用单例…有人和我一样的疑问，而且是在2年前…现在还没解决，我真的挺无语的</p>
<p><a target="_blank" rel="noopener" href="https://forum.golangbridge.org/t/how-to-resolve-those-golang-ci-lint-issue/17168">https://forum.golangbridge.org/t/how-to-resolve-those-golang-ci-lint-issue/17168</a></p>
<p>所以我被迫提问: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/72709336/how-to-use-sync-once-in-golangci-lint-i-got-err-once-is-a-global-variable-goc">https://stackoverflow.com/questions/72709336/how-to-use-sync-once-in-golangci-lint-i-got-err-once-is-a-global-variable-goc</a></p>
<h2 id="尝试以及新问题"><a href="#尝试以及新问题" class="headerlink" title="尝试以及新问题"></a>尝试以及新问题</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _backTask backTask <span class="comment">//go:embed test</span></span><br></pre></td></tr></table></figure>
<p>确实没有全局变量报错，但是出了新问题:(我之前还以为是双斜线必须和文本之间有空格的comment的那个warning，结果是另外的warning)<br>The “embed” package must be imported when using go:embed directives.embed</p>
<h2 id="stackoverflow最终结果"><a href="#stackoverflow最终结果" class="headerlink" title="stackoverflow最终结果"></a>stackoverflow最终结果</h2><p>我好不容易回答了一个C/C++的问题，然后获得了1个赞，stackoverflow声誉达到11点，想着再问一个好问题，去达到15点，拥有投票权，结果被两个大佬批了（stackoverflow的veto(否决):This question does not show any research effort; it is unclear or not useful），说我完全可以不用这个全局检测，真的尴尬，然后声誉掉到了7点</p>
<p>vote: 投票<br>veto: 否决</p>
<p>不删除问题吧，我觉得有些人应该也会犯我的错，用这个留作教训</p>
<blockquote>
<p>There are many cases where package-level variables are appropriate and this is one of them. Check to see if there’s a source code comment that you can use to silence the warning from the problem tool. –<br>RedBlue<br> 4 hours ago</p>
</blockquote>
<blockquote>
<p>You have a lot of options: 1. Do not run golangcli-lint at all. 2. Disable the noglobals rule. 3. Do not use a global. –<br>Volker<br> 4 hours ago</p>
</blockquote>
<p>不过还好让我知道了不能全信golangci-lint中集成的一些lint，因为有些lint比较极端，看过了<a target="_blank" rel="noopener" href="https://peter.bourgon.org/blog/2017/06/09/theory-of-modern-go.html">A theory of modern Go</a>，其实也应该知道这不是要禁止所有的global variables…</p>
<p>后续更新: 第二天去看stackoverflow，发现这个提问被upvote了一下，加了10点声誉，然后问题被系统关闭了，但是自己却因为这个upvote获得的10点声誉，达到了17点声誉，从而获得了vote的权利!绝了，没想到啊!然后看到自己以前的answer被别人upvote并且comment说有趣的绕行解决方案，我感觉很开心。以后多玩玩stackoverflow，这是一个好平台，管理得很细致，nice的</p>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/86.html">Go语言类型分支（switch判断空接口中变量的类型）</a></p>
<h1 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h1><p>推荐看《黑客与画家》这本书，思考于2001，成文于2003年，翻译于2010年，但是现在看还是会被里面的观点给惊讶到，感觉很多观点放在现在都非常适用，而且在一一验证。并且打破惯性的一些偏见思维。非常好的一本书。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/alipay.jpg" alt="单林敏 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/ARST/" rel="tag"># ARST</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/ARST%E6%89%93%E5%8D%A1%E7%AC%AC163%E5%91%A8-163-521/" rel="prev" title="ARST打卡第163周[163/521]">
                  <i class="fa fa-chevron-left"></i> ARST打卡第163周[163/521]
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/ARST%E6%89%93%E5%8D%A1%E7%AC%AC165%E5%91%A8-165-521/" rel="next" title="ARST打卡第165周[165/521]">
                  ARST打卡第165周[165/521] <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">湘ICP备19025607号 </a>
  </div>

<div class="copyright">
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">单林敏</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"wolfdan666","repo":"gitalk_commont","client_id":"2934cb0fdcabc560461e","client_secret":"937e7b77dcdfd83f6a89f4a9b9447a76a54bc764","admin_user":"wolfdan666","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"1a740ff23df5c0cec7a4cea40a547c8b"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
